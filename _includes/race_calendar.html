{% comment %}
Races Include Template
Usage: {% include race_calendar.html year="2025" %}
Parameters:
- year: The year to filter races (required)
{% endcomment %}

{% assign calendar_year = include.year | default: "2025" %}

{% comment %} Calculate race statistics for the year {% endcomment %}
{% assign race_posts = site.running | where_exp: "post", "post.tags contains 'race'" | sort: "date" | reverse %}
{% assign total_km = 0 %}
{% assign ultra_count = 0 %}
{% assign non_ultra_count = 0 %}
{% assign race_count = 0 %}
{% assign total_elevation = 0 %}
{% assign trail_count = 0 %}
{% assign non_trail_count = 0 %}
{% assign backyard_count = 0 %}

{% for post in race_posts %}
  {% comment %} Use race_date if available, otherwise fall back to post.date {% endcomment %}
  {% assign race_date = post.race_date | default: post.date %}
  {% assign post_year = race_date | date: "%Y" %}
  {% if post_year == calendar_year and post.distance_km %}
    {% assign race_count = race_count | plus: 1 %}
    {% assign total_km = total_km | plus: post.distance_km %}
    {% assign distance_num = post.distance_km | plus: 0 %}
    
    {% comment %} Ultra vs non-ultra {% endcomment %}
    {% if distance_num >= 50 %}
      {% assign ultra_count = ultra_count | plus: 1 %}
    {% else %}
      {% assign non_ultra_count = non_ultra_count | plus: 1 %}
    {% endif %}
    
    {% comment %} Total elevation gain {% endcomment %}
    {% if post.elevation_gain_m %}
      {% assign total_elevation = total_elevation | plus: post.elevation_gain_m %}
    {% endif %}
    
    {% comment %} Trail vs non-trail {% endcomment %}
    {% if post.tags contains "trailrunning" %}
      {% assign trail_count = trail_count | plus: 1 %}
    {% else %}
      {% assign non_trail_count = non_trail_count | plus: 1 %}
    {% endif %}
    
    {% comment %} Backyard ultra count {% endcomment %}
    {% if post.tags contains "backyard-ultra" %}
      {% assign backyard_count = backyard_count | plus: 1 %}
    {% endif %}
  {% endif %}
{% endfor %}

<div class="races-container">
  {% comment %} Race Statistics {% endcomment %}
  {% if race_count > 0 %}
  <div class="race-stats mb-4">
    <div class="stats-grid">
      <div class="stat-item">
        <span class="stat-number">{{ total_km }}km</span>
        <span class="stat-label">Total Distance</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ total_elevation }}m</span>
        <span class="stat-label">Total Elevation</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ ultra_count }}</span>
        <span class="stat-label">Ultras (≥50km)</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ non_ultra_count }}</span>
        <span class="stat-label">Non-Ultras (<50km)</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ trail_count }}</span>
        <span class="stat-label">Trail Races</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ non_trail_count }}</span>
        <span class="stat-label">Road Races</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ backyard_count }}</span>
        <span class="stat-label">Backyard Ultras</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ race_count }}</span>
        <span class="stat-label">Total Races</span>
      </div>
    </div>
  </div>
  {% endif %}
  
  {% comment %} Races Table {% endcomment %}
  <div class="table-responsive">
    <table class="table table-hover races-table">
      <thead class="thead-light">
        <tr>
          <th scope="col" class="date-col">Date</th>
          <th scope="col" class="race-col">Race</th>
          <th scope="col" class="distance-col">Dist / Vert</th>
          <th scope="col" class="tags-col">Type</th>
        </tr>
      </thead>
      <tbody>
        {% assign race_posts = site.running | where_exp: "post", "post.tags contains 'race'" | sort: "date" | reverse %}
        
        {% comment %} Find the maximum distance and elevation gain for highlighting {% endcomment %}
        {% assign max_distance = 0 %}
        {% assign max_elevation = 0 %}
        {% for post in race_posts %}
          {% comment %} Use race_date if available, otherwise fall back to post.date {% endcomment %}
          {% assign race_date = post.race_date | default: post.date %}
          {% assign post_year = race_date | date: "%Y" %}
          {% if post_year == calendar_year %}
            {% if post.distance_km %}
              {% assign current_distance = post.distance_km | plus: 0 %}
              {% if current_distance > max_distance %}
                {% assign max_distance = current_distance %}
              {% endif %}
            {% endif %}
            {% if post.elevation_gain_m %}
              {% assign current_elevation = post.elevation_gain_m | plus: 0 %}
              {% if current_elevation > max_elevation %}
                {% assign max_elevation = current_elevation %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
        
        {% for post in race_posts %}
          {% comment %} Use race_date if available, otherwise fall back to post.date {% endcomment %}
          {% assign race_date = post.race_date | default: post.date %}
          {% assign post_year = race_date | date: "%Y" %}
          {% if post_year == calendar_year %}
          {% assign current_distance = post.distance_km | plus: 0 %}
          {% assign current_elevation = post.elevation_gain_m | plus: 0 %}
          {% assign is_longest_race = false %}
          {% assign is_highest_elevation = false %}
          {% if current_distance == max_distance and current_distance > 0 %}
            {% assign is_longest_race = true %}
          {% endif %}
          {% if current_elevation == max_elevation and current_elevation > 0 %}
            {% assign is_highest_elevation = true %}
          {% endif %}
          {% assign row_classes = '' %}
          {% if is_longest_race %}
            {% assign row_classes = row_classes | append: 'longest-race ' %}
          {% endif %}
          {% if is_highest_elevation %}
            {% assign row_classes = row_classes | append: 'highest-elevation ' %}
          {% endif %}
          <tr{% if row_classes != '' %} class="{{ row_classes | strip }}"{% endif %}>
            <td class="date-cell">
              <span class="race-date">{{ race_date | date: "%b-%d" }}</span>
            </td>
            <td class="race-cell">
              <a href="{{ post.url }}" class="race-link">{{ post.title }}</a>
            </td>
            <td class="distance-cell">
              {% if post.distance_km %}
                <div class="distance-info">
                  <span class="distance-value">{{ post.distance_km }} km</span>
                  {% if post.elevation_gain_m %}
                    <span class="elevation-value">{{ post.elevation_gain_m }} m</span>
                  {% endif %}
                </div>
              {% else %}
                <span class="distance-unknown">—</span>
              {% endif %}
            </td>
            <td class="tags-cell">
              {% comment %} Show race type tags with colors {% endcomment %}
              {% assign race_type_tags = 'trailrunning,ultrarunning,halfmarathon,marathon,backyard-ultra' | split: ',' %}
              {% assign display_tags = '' %}
              {% assign tag_classes = '' %}
              {% for tag in post.tags %}
                {% if race_type_tags contains tag %}
                  {% if tag == 'trailrunning' %}
                    {% assign display_tags = display_tags | append: 'trail' | append: ',' %}
                    {% assign tag_classes = tag_classes | append: 'race-tag-trail' | append: ',' %}
                  {% elsif tag == 'ultrarunning' %}
                    {% assign display_tags = display_tags | append: 'ultra' | append: ',' %}
                    {% assign tag_classes = tag_classes | append: 'race-tag-ultra' | append: ',' %}
                  {% elsif tag == 'halfmarathon' %}
                    {% assign display_tags = display_tags | append: 'half' | append: ',' %}
                    {% assign tag_classes = tag_classes | append: 'race-tag-half' | append: ',' %}
                  {% elsif tag == 'marathon' %}
                    {% assign display_tags = display_tags | append: 'marathon' | append: ',' %}
                    {% assign tag_classes = tag_classes | append: 'race-tag-marathon' | append: ',' %}
                  {% elsif tag == 'backyard-ultra' %}
                    {% assign display_tags = display_tags | append: 'backyard' | append: ',' %}
                    {% assign tag_classes = tag_classes | append: 'race-tag-backyard' | append: ',' %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {% if display_tags != '' %}
                <div class="race-tags-table">
                  {% assign tag_array = display_tags | split: ',' %}
                  {% assign class_array = tag_classes | split: ',' %}
                  {% for tag in tag_array %}
                    {% if tag != '' %}
                    <span class="race-tag {{ class_array[forloop.index0] }}">{{ tag }}</span>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </td>
          </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <div class="races-footer text-center mt-4">
    <a href="/tags#race" class="view-all-races">View all races →</a>
  </div>
</div>
