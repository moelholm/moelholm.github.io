{% comment %}
Race Calendar Include Template
Usage: {% include race_calendar.html year="2025" title_icon="fa-solid fa-flag-checkered" %}
Parameters:
- year: The year to filter races (required)
- title_icon: Font Awesome icon class for the title (optional, defaults to fa-solid fa-flag-checkered)
- title_suffix: Additional text after "Race Calendar" (optional, defaults to empty)
{% endcomment %}

{% assign calendar_year = include.year | default: "2025" %}
{% assign icon_class = include.title_icon | default: "fa-solid fa-flag-checkered" %}
{% assign title_suffix = include.title_suffix | default: "" %}

{% comment %} Calculate race statistics for the year {% endcomment %}
{% assign race_posts = site.running | where_exp: "post", "post.tags contains 'race'" | sort: "date" | reverse %}
{% assign total_km = 0 %}
{% assign ultra_count = 0 %}
{% assign non_ultra_count = 0 %}
{% assign race_count = 0 %}

{% for post in race_posts %}
  {% assign post_year = post.date | date: "%Y" %}
  {% if post_year == calendar_year and post.distance_km %}
    {% assign race_count = race_count | plus: 1 %}
    {% assign total_km = total_km | plus: post.distance_km %}
    {% assign distance_num = post.distance_km | plus: 0 %}
    {% if distance_num >= 50 %}
      {% assign ultra_count = ultra_count | plus: 1 %}
    {% else %}
      {% assign non_ultra_count = non_ultra_count | plus: 1 %}
    {% endif %}
  {% endif %}
{% endfor %}

<div class="race-calendar">
  {% comment %} Race Statistics {% endcomment %}
  {% if race_count > 0 %}
  <div class="race-stats">
    <div class="stats-grid">
      <div class="stat-item">
        <span class="stat-number">{{ total_km }}km</span>
        <span class="stat-label">Total Distance</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ ultra_count }}</span>
        <span class="stat-label">Ultras (≥50km)</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ non_ultra_count }}</span>
        <span class="stat-label">Non-Ultras (<50km)</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ race_count }}</span>
        <span class="stat-label">Total Races</span>
      </div>
    </div>
  </div>
  {% endif %}
  
  <ul class="race-list">
    {% assign race_posts = site.running | where_exp: "post", "post.tags contains 'race'" | sort: "date" | reverse %}
    {% for post in race_posts %}
      {% assign post_year = post.date | date: "%Y" %}
      {% if post_year == calendar_year %}
      <li>
        <a href="{{ post.url }}">
          <span class="race-date">{{ post.date | date: "%Y-%m-%d" }}</span>
          <span class="race-title-container">
            <span class="race-title">{{ post.title }}</span>
            {% comment %} Show only race type tags with shorter display names and colors {% endcomment %}
            {% assign race_type_tags = 'trailrunning,ultrarunning,halfmarathon,marathon,backyard-ultra' | split: ',' %}
            {% assign display_tags = '' %}
            {% assign tag_classes = '' %}
            {% for tag in post.tags %}
              {% if race_type_tags contains tag %}
                {% if tag == 'trailrunning' %}
                  {% assign display_tags = display_tags | append: 'trail' | append: ',' %}
                  {% assign tag_classes = tag_classes | append: 'race-tag-trail' | append: ',' %}
                {% elsif tag == 'ultrarunning' %}
                  {% assign display_tags = display_tags | append: 'ultra' | append: ',' %}
                  {% assign tag_classes = tag_classes | append: 'race-tag-ultra' | append: ',' %}
                {% elsif tag == 'halfmarathon' %}
                  {% assign display_tags = display_tags | append: 'half' | append: ',' %}
                  {% assign tag_classes = tag_classes | append: 'race-tag-half' | append: ',' %}
                {% elsif tag == 'marathon' %}
                  {% assign display_tags = display_tags | append: 'marathon' | append: ',' %}
                  {% assign tag_classes = tag_classes | append: 'race-tag-marathon' | append: ',' %}
                {% elsif tag == 'backyard-ultra' %}
                  {% assign display_tags = display_tags | append: 'backyard' | append: ',' %}
                  {% assign tag_classes = tag_classes | append: 'race-tag-backyard' | append: ',' %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if display_tags != '' %}
            <span class="race-tags">
              {% assign tag_array = display_tags | split: ',' %}
              {% assign class_array = tag_classes | split: ',' %}
              {% for tag in tag_array %}
                {% if tag != '' %}
                <span class="race-tag {{ class_array[forloop.index0] }}">{{ tag }}</span>
                {% endif %}
              {% endfor %}
            </span>
            {% endif %}
          </span>
        </a>
      </li>
      {% endif %}
    {% endfor %}
  </ul>
  
  <div class="race-calendar-footer">
    <a href="/tags#race" class="view-all-races">View all races →</a>
  </div>
</div>
