{% comment %}
Render races table for calendar_year with row classes and tag labels wired to filters.
Inputs:
- calendar_year
{% endcomment %}
<div class="table-responsive">
  <table class="table table-hover races-table">
    <thead class="thead-light">
      <tr>
        <th scope="col" class="date-col">Date</th>
        <th scope="col" class="race-col">Race</th>
        <th scope="col" class="distance-col">Dist / Vert</th>
        <th scope="col" class="tags-col">Type</th>
      </tr>
    </thead>
    <tbody>
      {% assign race_posts = site.running | where_exp: "post", "post.tags contains 'race'" | sort: "date" | reverse %}
      {% assign max_distance = 0 %}
      {% assign max_elevation = 0 %}
      {% for post in race_posts %}
        {% assign race_date = post.race_date | default: post.date %}
        {% assign post_year = race_date | date: "%Y" %}
        {% if post_year == calendar_year %}
          {% if post.distance_km %}
            {% assign current_distance = post.distance_km | plus: 0 %}
            {% if current_distance > max_distance %}{% assign max_distance = current_distance %}{% endif %}
          {% endif %}
          {% if post.elevation_gain_m %}
            {% assign current_elevation = post.elevation_gain_m | plus: 0 %}
            {% if current_elevation > max_elevation %}{% assign max_elevation = current_elevation %}{% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}

      {% for post in race_posts %}
        {% assign race_date = post.race_date | default: post.date %}
        {% assign post_year = race_date | date: "%Y" %}
        {% if post_year == calendar_year %}
          {% assign current_distance = post.distance_km | plus: 0 %}
          {% assign current_elevation = post.elevation_gain_m | plus: 0 %}
          {% assign is_longest_race = false %}
          {% assign is_highest_elevation = false %}
          {% if current_distance == max_distance and current_distance > 0 %}{% assign is_longest_race = true %}{% endif %}
          {% if current_elevation == max_elevation and current_elevation > 0 %}{% assign is_highest_elevation = true %}{% endif %}

          {% assign row_classes = '' %}
          {% if current_distance >= 50 %}
            {% assign row_classes = row_classes | append: 'tag-ultra ' %}
          {% else %}
            {% assign row_classes = row_classes | append: 'tag-non-ultra ' %}
          {% endif %}
          {% if post.tags contains 'trailrunning' %}
            {% assign row_classes = row_classes | append: 'tag-trail ' %}
          {% else %}
            {% assign row_classes = row_classes | append: 'tag-road ' %}
          {% endif %}
          {% if post.tags contains 'backyard-ultra' %}
            {% assign row_classes = row_classes | append: 'tag-backyard ' %}
          {% endif %}
          {% if is_longest_race %}{% assign row_classes = row_classes | append: 'longest-race ' %}{% endif %}
          {% if is_highest_elevation %}{% assign row_classes = row_classes | append: 'highest-elevation ' %}{% endif %}

          <tr{% if row_classes != '' %} class="{{ row_classes | strip }}"{% endif %}>
            <td class="date-cell"><span class="race-date">{{ race_date | date: "%b-%d" }}</span></td>
            <td class="race-cell"><a href="{{ post.url }}" class="race-link">{{ post.title }}</a></td>
            <td class="distance-cell">
              {% if post.distance_km %}
                <div class="distance-info">
                  <span class="distance-value">{{ post.distance_km }} km</span>
                  {% if post.elevation_gain_m %}<span class="elevation-value">{{ post.elevation_gain_m }} m</span>{% endif %}
                </div>
              {% else %}
                <span class="distance-unknown">â€”</span>
              {% endif %}
            </td>
            <td class="tags-cell">
              {% assign race_type_tags = 'trailrunning,ultrarunning,halfmarathon,marathon,backyard-ultra' | split: ',' %}
              {% assign display_tags = '' %}
              {% assign tag_classes = '' %}
              {% for tag in post.tags %}
                {% if race_type_tags contains tag %}
                  {% if tag == 'trailrunning' %}
                    {% assign display_tags = display_tags | append: 'trail,' %}
                    {% assign tag_classes = tag_classes | append: 'race-tag-trail,' %}
                  {% elsif tag == 'ultrarunning' %}
                    {% assign display_tags = display_tags | append: 'ultra,' %}
                    {% assign tag_classes = tag_classes | append: 'race-tag-ultra,' %}
                  {% elsif tag == 'halfmarathon' %}
                    {% assign display_tags = display_tags | append: 'half,' %}
                    {% assign tag_classes = tag_classes | append: 'race-tag-half,' %}
                  {% elsif tag == 'marathon' %}
                    {% assign display_tags = display_tags | append: 'marathon,' %}
                    {% assign tag_classes = tag_classes | append: 'race-tag-marathon,' %}
                  {% elsif tag == 'backyard-ultra' %}
                    {% assign display_tags = display_tags | append: 'backyard,' %}
                    {% assign tag_classes = tag_classes | append: 'race-tag-backyard,' %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {% if display_tags != '' %}
                <div class="race-tags-table">
                  {% assign tag_array = display_tags | split: ',' %}
                  {% assign class_array = tag_classes | split: ',' %}
                  {% for tag in tag_array %}
                    {% if tag != '' %}
                      {% assign filter_for = '' %}
                      {% if tag == 'ultra' %}
                        {% assign filter_for = 'filter-ultra-' | append: calendar_year %}
                      {% elsif tag == 'trail' %}
                        {% assign filter_for = 'filter-trail-' | append: calendar_year %}
                      {% elsif tag == 'backyard' %}
                        {% assign filter_for = 'filter-backyard-' | append: calendar_year %}
                      {% elsif tag == 'half' or tag == 'marathon' %}
                        {% assign filter_for = 'filter-road-' | append: calendar_year %}
                      {% endif %}
                      {% if filter_for != '' %}
                        <label for="{{ filter_for }}" class="race-tag {{ class_array[forloop.index0] }}" title="Filter by {{ tag }}">{{ tag }}</label>
                      {% else %}
                        <span class="race-tag {{ class_array[forloop.index0] }}">{{ tag }}</span>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </td>
          </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>
</div>
