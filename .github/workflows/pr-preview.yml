name: PR Preview (Netlify)

on:
  pull_request:
    branches: [ master ]
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    # Only run deploy for open PRs, not closed
    if: github.event.action != 'closed'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false
      
      - name: Install Jekyll dependencies
        run: |
          cd site
          bundle install
      
      - name: Build Jekyll site with drafts and future posts
        run: |
          cd site
          bundle exec jekyll build --drafts --future
        env:
          JEKYLL_ENV: preview
      
      - name: Install Netlify CLI
        run: npm install -g netlify-cli
      
      - name: Clean up old deployments for this PR
        run: |
          # Clean up old deployments with the same alias to avoid accumulation
          PR_ALIAS="pr-${{ github.event.pull_request.number }}"
          echo "Cleaning up old deployments for alias: $PR_ALIAS"
          
          # List all deploys and find those matching this PR alias
          if DEPLOYS=$(netlify api listSiteDeploys \
            --data="$(jq -n --arg site_id "${{ secrets.NETLIFY_SITE_ID }}" '{site_id: $site_id}')"); then
            
            # Find all deployment IDs matching this PR alias
            DEPLOY_IDS=$(echo "$DEPLOYS" | jq -r --arg alias "$PR_ALIAS" \
              '.[] | select(.name == $alias or (.deploy_ssl_url | tostring | test("^https?://" + $alias + "--"))) | .id')
            
            if [ -n "$DEPLOY_IDS" ]; then
              echo "Found existing deployments to clean up"
              # Delete each old deployment
              echo "$DEPLOY_IDS" | while read -r deploy_id; do
                if [ -n "$deploy_id" ]; then
                  echo "Deleting deployment: $deploy_id"
                  netlify api deleteSiteDeploy \
                    --data="$(jq -n --arg site_id "${{ secrets.NETLIFY_SITE_ID }}" --arg deploy_id "$deploy_id" '{site_id: $site_id, deploy_id: $deploy_id}')" \
                    || echo "Failed to delete deployment $deploy_id (may already be deleted)"
                fi
              done
              echo "Cleanup completed"
            else
              echo "No existing deployments found for this PR"
            fi
          else
            echo "Failed to list deployments, proceeding with new deployment anyway"
          fi
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        continue-on-error: true
      
      - name: Deploy to Netlify
        id: netlify-deploy
        run: |
          netlify deploy \
            --dir=site/_site \
            --site=${{ secrets.NETLIFY_SITE_ID }} \
            --auth=${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --alias=pr-${{ github.event.pull_request.number }} \
            --message="PR #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}" \
            --json > deploy-output.json
          
          echo "deploy-url=$(jq -r '.deploy_url' deploy-output.json)" >> $GITHUB_OUTPUT
        timeout-minutes: 5
      
      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ steps.netlify-deploy.outputs.deploy-url }}';
            const comment = `
            ### ðŸš€ Netlify Preview Deployment
            
            âœ… Preview URL: ${deployUrl}
            
            ðŸ“ PR #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Netlify Preview Deployment')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
  
  cleanup-preview:
    runs-on: ubuntu-latest
    # Only run cleanup when PR is closed
    if: github.event.action == 'closed'
    steps:
      - name: Install Netlify CLI
        run: npm install -g netlify-cli
      
      - name: Delete Netlify deployment
        run: |
          # Get the deployment ID for the PR alias
          PR_ALIAS="pr-${{ github.event.pull_request.number }}"
          echo "Looking for deployment with alias: $PR_ALIAS"
          
          # List all deploys for the site and find the one with matching alias
          # Using jq to properly construct the JSON payload
          if ! DEPLOYS=$(netlify api listSiteDeploys \
            --data="$(jq -n --arg site_id "${{ secrets.NETLIFY_SITE_ID }}" '{site_id: $site_id}')"); then
            echo "Failed to list deployments" >&2
            exit 0
          fi
          
          # Extract deploy_id from the response
          # Match deployments where:
          # 1. The name field exactly matches the PR alias, OR
          # 2. The deploy_ssl_url contains the alias as a subdomain (e.g., pr-42--site.netlify.app)
          # Note: The alias is expected to be safe (just "pr-" followed by a number)
          DEPLOY_ID=$(echo "$DEPLOYS" | jq -r --arg alias "$PR_ALIAS" \
            '.[] | select(.name == $alias or (.deploy_ssl_url | tostring | test("^https?://" + $alias + "--"))) | .id' | head -1)
          
          if [ -n "$DEPLOY_ID" ]; then
            echo "Found deployment ID: $DEPLOY_ID, deleting..."
            # Use jq to properly construct the JSON payload
            if netlify api deleteSiteDeploy \
              --data="$(jq -n --arg site_id "${{ secrets.NETLIFY_SITE_ID }}" --arg deploy_id "$DEPLOY_ID" '{site_id: $site_id, deploy_id: $deploy_id}')"; then
              echo "Deployment deleted successfully"
            else
              echo "Failed to delete deployment" >&2
            fi
          else
            echo "No deployment found for alias $PR_ALIAS"
          fi
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        continue-on-error: true
