name: PR Preview (Netlify)

on:
  pull_request:
    branches: [ master ]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false
      
      - name: Install Jekyll dependencies
        run: |
          cd site
          bundle install
      
      - name: Build Jekyll site with drafts and future posts
        run: |
          cd site
          bundle exec jekyll build --drafts --future
        env:
          JEKYLL_ENV: preview
      
      - name: Install Netlify CLI
        run: npm install -g netlify-cli
      
      - name: Clean up old deployments for this PR
        run: |
          # Clean up old deployments with the same alias to avoid accumulation
          PR_ALIAS="pr-${{ github.event.pull_request.number }}"
          echo "Cleaning up old deployments for alias: $PR_ALIAS"
          
          # List all deploys and find those matching this PR alias
          if DEPLOYS=$(netlify api listSiteDeploys \
            --data="$(jq -n --arg site_id "${{ secrets.NETLIFY_SITE_ID }}" '{site_id: $site_id}')"); then
            
            # Find all deployment IDs matching this PR alias
            DEPLOY_IDS=$(echo "$DEPLOYS" | jq -r --arg alias "$PR_ALIAS" \
              '.[] | select(.name == $alias or (.deploy_ssl_url | tostring | test("^https?://" + $alias + "--"))) | .id')
            
            if [ -n "$DEPLOY_IDS" ]; then
              echo "Found existing deployments to clean up"
              # Delete each old deployment
              echo "$DEPLOY_IDS" | while read -r deploy_id; do
                if [ -n "$deploy_id" ]; then
                  echo "Deleting deployment: $deploy_id"
                  netlify api deleteSiteDeploy \
                    --data="$(jq -n --arg site_id "${{ secrets.NETLIFY_SITE_ID }}" --arg deploy_id "$deploy_id" '{site_id: $site_id, deploy_id: $deploy_id}')" \
                    || echo "Failed to delete deployment $deploy_id (may already be deleted)"
                fi
              done
              echo "Cleanup completed"
            else
              echo "No existing deployments found for this PR"
            fi
          else
            echo "Failed to list deployments, proceeding with new deployment anyway"
          fi
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        continue-on-error: true
      
      - name: Deploy to Netlify
        id: netlify-deploy
        run: |
          netlify deploy \
            --dir=site/_site \
            --site=${{ secrets.NETLIFY_SITE_ID }} \
            --auth=${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --alias=pr-${{ github.event.pull_request.number }} \
            --message="PR #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}" \
            --json > deploy-output.json
          
          echo "deploy-url=$(jq -r '.deploy_url' deploy-output.json)" >> $GITHUB_OUTPUT
        timeout-minutes: 5
      
      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ steps.netlify-deploy.outputs.deploy-url }}';
            const comment = `
            ### ðŸš€ Netlify Preview Deployment
            
            âœ… Preview URL: ${deployUrl}
            
            ðŸ“ PR #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Netlify Preview Deployment')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

