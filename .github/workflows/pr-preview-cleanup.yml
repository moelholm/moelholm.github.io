name: PR Preview Cleanup

on:
  pull_request:
    branches: [ master ]
    types: [closed]

permissions:
  contents: read
  pull-requests: write

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Install Netlify CLI
        run: npm install -g netlify-cli
      
      - name: Delete Netlify deployment
        run: |
          # Get the deployment ID for the PR alias
          PR_ALIAS="pr-${{ github.event.pull_request.number }}"
          echo "Looking for deployment with alias: $PR_ALIAS"
          
          # List all deploys for the site and find the one with matching alias
          # Using jq to properly construct the JSON payload
          if ! DEPLOYS=$(netlify api listSiteDeploys \
            --data="$(jq -n --arg site_id "${{ secrets.NETLIFY_SITE_ID }}" '{site_id: $site_id}')"); then
            echo "Failed to list deployments" >&2
            exit 0
          fi
          
          # Extract deploy_id from the response
          # Match deployments where:
          # 1. The name field exactly matches the PR alias, OR
          # 2. The deploy_ssl_url contains the alias as a subdomain (e.g., pr-42--site.netlify.app)
          # Note: The alias is expected to be safe (just "pr-" followed by a number)
          DEPLOY_IDS=$(echo "$DEPLOYS" | jq -r --arg alias "$PR_ALIAS" \
            '.[] | select(.name == $alias or (.deploy_ssl_url | tostring | test("^https?://" + $alias + "--"))) | .id')
          
          if [ -n "$DEPLOY_IDS" ]; then
            echo "Found deployments to delete"
            # Delete each deployment
            echo "$DEPLOY_IDS" | while read -r deploy_id; do
              if [ -n "$deploy_id" ]; then
                echo "Deleting deployment: $deploy_id"
                # Use jq to properly construct the JSON payload
                if netlify api deleteSiteDeploy \
                  --data="$(jq -n --arg site_id "${{ secrets.NETLIFY_SITE_ID }}" --arg deploy_id "$deploy_id" '{site_id: $site_id, deploy_id: $deploy_id}')"; then
                  echo "Deployment $deploy_id deleted successfully"
                else
                  echo "Failed to delete deployment $deploy_id" >&2
                fi
              fi
            done
          else
            echo "No deployment found for alias $PR_ALIAS"
          fi
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        continue-on-error: true
