name: Auto-merge toot PRs

on:
  # Only run when the fetch-toots workflow completes successfully
  workflow_run:
    workflows: ["fetch-toots"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge_from_run:
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Merge open toot PR when fetch-toots completes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          # Only act for default branch workflow runs
          if [ "${{ github.event.workflow_run.head_branch }}" != "master" ]; then
            echo "Workflow run was for branch '${{ github.event.workflow_run.head_branch }}'; skipping."
            exit 0
          fi
          # Find an open PR from the bot branch
          pr_number=$(gh pr list --repo "$REPO" --head bot/mastodon-toots --state open --json number --jq '.[0].number // empty')
          if [ -z "${pr_number:-}" ]; then
            echo "No open PR from bot/mastodon-toots; nothing to merge."
            exit 0
          fi
          # Ensure it has the 'toots' label
          if ! gh pr view "$pr_number" --repo "$REPO" --json labels --jq '.labels[].name' | grep -qx toots; then
            echo "PR #$pr_number found but without 'toots' label; skipping."
            exit 0
          fi
          # Merge immediately to ensure this workflow finishes after the merge is applied
          gh pr merge "$pr_number" --repo "$REPO" --squash --delete-branch
          echo "Merged PR #$pr_number. Dispatching 'toots-merged' event to trigger Pages build."
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$REPO/dispatches \
            -d '{"event_type":"toots-merged"}'
          echo "repository_dispatch event sent."