{% comment %}
Render races table for calendar_year with row classes and tag labels wired to filters.
Inputs:
- calendar_year
{% endcomment %}
<div class="table-responsive">
  <table class="table races-table races-table--nohead">
    <thead class="thead-light"><tr><th class="date-col"></th><th class="race-details-col"></th></tr></thead>
    <tbody>
  {% assign race_posts = race_posts_all %}
      {% assign max_distance = 0 %}
      {% assign max_elevation = 0 %}
      {% assign max_duration = 0 %}
      {% for post in race_posts %}
        {% assign race_date = post.race_date | default: post.date %}
        {% assign post_year = race_date | date: "%Y" %}
        {% if post_year == calendar_year %}
          {% if post.distance_km %}
            {% assign current_distance = post.distance_km | plus: 0 %}
            {% if current_distance > max_distance %}{% assign max_distance = current_distance %}{% endif %}
          {% endif %}
          {% if post.elevation_gain_m %}
            {% assign current_elevation = post.elevation_gain_m | plus: 0 %}
            {% if current_elevation > max_elevation %}{% assign max_elevation = current_elevation %}{% endif %}
          {% endif %}
          {% if post.duration_formatted %}
            {% include duration_to_seconds.html duration=post.duration_formatted %}
            {% assign current_duration = duration_seconds | plus: 0 %}
            {% if current_duration > max_duration %}{% assign max_duration = current_duration %}{% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}

      {% for post in race_posts %}
        {% assign race_date = post.race_date | default: post.date %}
        {% assign post_year = race_date | date: "%Y" %}
        {% if post_year == calendar_year %}
          {% assign current_distance = post.distance_km | plus: 0 %}
          {% assign current_elevation = post.elevation_gain_m | plus: 0 %}
          {% assign current_duration = 0 %}
          {% if post.duration_formatted %}{% include duration_to_seconds.html duration=post.duration_formatted %}{% assign current_duration = duration_seconds | plus: 0 %}{% endif %}
          {% assign is_longest_race = false %}
          {% assign is_highest_elevation = false %}
          {% assign is_longest_duration = false %}
          {% if current_distance == max_distance and current_distance > 0 %}{% assign is_longest_race = true %}{% endif %}
          {% if current_elevation == max_elevation and current_elevation > 0 %}{% assign is_highest_elevation = true %}{% endif %}
          {% if current_duration == max_duration and current_duration > 0 %}{% assign is_longest_duration = true %}{% endif %}

          {% assign row_classes = '' %}
          {% if current_distance >= 50 %}
            {% assign row_classes = row_classes | append: 'tag-ultra ' %}
          {% else %}
            {% assign row_classes = row_classes | append: 'tag-non-ultra ' %}
          {% endif %}
          {% if post.tags contains 'trailrunning' %}
            {% assign row_classes = row_classes | append: 'tag-trail ' %}
          {% else %}
            {% assign row_classes = row_classes | append: 'tag-road ' %}
          {% endif %}
          {% if post.tags contains 'backyard-ultra' %}
            {% assign row_classes = row_classes | append: 'tag-backyard ' %}
          {% endif %}
          {% if is_longest_race %}{% assign row_classes = row_classes | append: 'longest-race ' %}{% endif %}
          {% if is_highest_elevation %}{% assign row_classes = row_classes | append: 'highest-elevation ' %}{% endif %}
          {% if is_longest_duration %}{% assign row_classes = row_classes | append: 'longest-duration ' %}{% endif %}

          <tr{% if row_classes != '' %} class="{{ row_classes | strip }}"{% endif %}>
            <td class="race-details-cell" colspan="2">
              {% capture title_html %}{{ post.title }}{% endcapture %}
              {% capture body_html %}
                <div class="race-meta">
                  {% if post.distance_km %}
                    <span class="meta-item distance-value">{{ post.distance_km }} km</span>
                  {% endif %}
                  {% if post.elevation_gain_m %}
                    <span class="meta-item elevation-value">{{ post.elevation_gain_m }} m</span>
                  {% endif %}
                  {% if current_duration > 0 %}
                    {% assign hours = current_duration | divided_by: 3600 | floor %}
                    {% assign remaining = current_duration | modulo: 3600 %}
                    {% assign minutes_only = remaining | divided_by: 60 | floor %}
                    <span class="meta-item duration-value" title="Duration">
                      {% if hours > 0 %}
                        {% if minutes_only > 0 %}{{ hours }}h{{ minutes_only }}m{% else %}{{ hours }}h{% endif %}
                      {% else %}
                        {{ minutes_only }}m
                      {% endif %}
                    </span>
                  {% endif %}

                  {% assign race_type_tags = 'trailrunning,ultrarunning,halfmarathon,marathon,backyard-ultra' | split: ',' %}
                  {% assign display_tags = '' %}
                  {% assign tag_classes = '' %}
                  {% for tag in post.tags %}
                    {% if race_type_tags contains tag %}
                      {% if tag == 'trailrunning' %}
                        {% assign display_tags = display_tags | append: 'trail,' %}
                        {% assign tag_classes = tag_classes | append: 'race-tag-trail,' %}
                      {% elsif tag == 'ultrarunning' %}
                        {% assign display_tags = display_tags | append: 'ultra,' %}
                        {% assign tag_classes = tag_classes | append: 'race-tag-ultra,' %}
                      {% elsif tag == 'halfmarathon' %}
                        {% assign display_tags = display_tags | append: 'half,' %}
                        {% assign tag_classes = tag_classes | append: 'race-tag-half,' %}
                      {% elsif tag == 'marathon' %}
                        {% assign display_tags = display_tags | append: 'marathon,' %}
                        {% assign tag_classes = tag_classes | append: 'race-tag-marathon,' %}
                      {% elsif tag == 'backyard-ultra' %}
                        {% assign display_tags = display_tags | append: 'backyard,' %}
                        {% assign tag_classes = tag_classes | append: 'race-tag-backyard,' %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if display_tags != '' %}
                    <span class="race-tags-inline race-tags-group">
                      {% assign tag_array = display_tags | split: ',' %}
                      {% assign class_array = tag_classes | split: ',' %}
                      {% for tag in tag_array %}
                        {% if tag != '' %}
                          {% assign filter_for = '' %}
                          {% if tag == 'ultra' %}
                            {% assign filter_for = 'filter-ultra-' | append: calendar_year %}
                          {% elsif tag == 'trail' %}
                            {% assign filter_for = 'filter-trail-' | append: calendar_year %}
                          {% elsif tag == 'backyard' %}
                            {% assign filter_for = 'filter-backyard-' | append: calendar_year %}
                          {% elsif tag == 'half' or tag == 'marathon' %}
                            {% assign filter_for = 'filter-road-' | append: calendar_year %}
                          {% endif %}
                          {% if filter_for != '' %}
                            <label for="{{ filter_for }}" class="race-tag {{ class_array[forloop.index0] }}" title="Filter by {{ tag }}">{{ tag }}</label>
                          {% else %}
                            <span class="race-tag {{ class_array[forloop.index0] }}">{{ tag }}</span>
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    </span>
                  {% endif %}
                </div>
              {% endcapture %}
              {% capture datetime_text %}{{ race_date | date: "%Y-%m-%d" }}{% endcapture %}
              {% include table_card.html datetime_text=datetime_text title_html=title_html href=post.url body_html=body_html %}
            </td>
          </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>
</div>
